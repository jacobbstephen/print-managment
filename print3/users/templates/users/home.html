{% extends "users/base.html" %}
{% load crispy_forms_tags %}
{% block content %}
    <div class="content-section">
        <div class="main">
            <form id="myForm" action="" method="post">
                {% csrf_token %}
                <div class="options">
                    <label for="Class">Class</label>
                    <select name='batch' id="ClassDropdown" onchange="loadLabs()">
                        <option value="" disabled selected>Select Class</option>
                        {% for batch in batches %}
                            <option value="{{ batch }}">{{ batch }}</option>
                        {% endfor %}
                    </select>
                    <label for="Class">Lab</label>
                    <select name="lab" id="LabDropdown">
                        <option value="" disabled selected>Select Lab</option>
                    </select>
                    <button type="submit" class="btn">Submit</button>
                </div>
            </form>
            {% if experiments_json %}
            <table id="printTable">
                <thead>
                    <tr>
                        <th>Roll No</th>
                        {% for name in exp_names_list %}
                            <th>{{name}}</th>
                        {% endfor %}
                        <th>Print</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>
        <script>
                document.addEventListener("DOMContentLoaded", function() {
                document.getElementById("myForm").addEventListener("submit", function(event) {
                    event.preventDefault(); // Prevent the default form submission
                    renderTable(); // Call the function to render the table after form submission
                });
            });

            function loadLabs(){
                var batch = document.getElementById("ClassDropdown").value;
                fetch(`labs/?batch=${batch}`,{method:'GET',})
                .then(res => res.json())
                .then(data => {
                    document.getElementById("LabDropdown").innerHTML = '';
                    for (var i = 0; i < data.length; i++) {
                        document.getElementById("LabDropdown").innerHTML += `<option value="${data[i]['lab_name']}">${data[i]['lab_name']}</option>`
                    }
                })
            }
            
            function renderTable() {
                console.log(`{{experiments_json}}`)
                var roll_list = JSON.parse(`{{ roll_list|safe }}`);
                var experiments = JSON.parse(`{{ experiments_json|safe }}`); //experiments is a JSON object
                const table_body = document.getElementById("tableBody");
                table_body.innerHTML = '';
                console.log(roll_list)
                for (let i = 0; i < roll_list.length; i++ ){
                    const tr = document.createElement("tr");
                    console.log(experiments[i])
                    const td = document.createElement("td");  
                    td.innerHTML = roll_list[i].toString();  
                    tr.appendChild(td);
                    for (var key in experiments[i]) {
                        if (experiments[i].hasOwnProperty(key)) {
                            const td1 = document.createElement("td");
                            if (experiments[i][key][2]){
                                td1.innerHTML = `<h3>Printed</h3>`
                            }
                            else if (experiments[i][key][0]){
                                const url = "http://127.0.0.1:8000/" + `${experiments[i][key][1]}`;
                                td1.innerHTML = `<button onClick=print('${url}')>Print</button>`;
                            }
                            else{
                                td1.innerHTML = `<h3>NULL</h3>`
                            }
                            tr.appendChild(td1);
                            // console.log(key + ": " + experiments[i][key]);
                        }
                    }
                    const td2 = document.createElement("td");
                    td2.innerHTML = `<button onClick=print_student('${i}')>Print all</button>`;
                    tr.appendChild(td2)
                    table_body.appendChild(tr);
                }
            }
            function print(url){
                fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(fileContent => {
                    var printWindow = window.open('', '_blank');
                    printWindow.document.write('<pre>' + fileContent + '</pre>');
                    printWindow.document.close();
                    printWindow.print();
                })
                .catch(error => {
                    console.error('There was a problem with fetching the file:', error);
                });
            }
            function print_student(i){
                var filePromises = [];
                var experiments = JSON.parse(`{{ experiments_json|safe }}`)
                for (var key in experiments[i]) {
                    if (experiments[i].hasOwnProperty(key)) {
                    // Check if the experiment belongs to the given studentId
                        if (experiments[i][key][0]) {
                            const url = "http://127.0.0.1:8000/" + `${experiments[i][key][1]}`;
                            filePromises.push(fetchFileContent(url));
                        }
                    }
                }
                Promise.all(filePromises)
                .then(fileContents => {
                    var combinedContent = fileContents.join('\n\n');
                    printContent(combinedContent);
                })
                .catch(error => {
                    console.error('There was a problem with fetching the file content:', error);
                });
            }
            function fetchFileContent(url) {
                return fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .catch(error => {
                    console.error('There was a problem with fetching the file:', error);
                    return ''; // Return empty string to avoid breaking Promise.all
                });
            }
            function printContent(content) {
                var printWindow = window.open('', '_blank');
                printWindow.document.write('<pre>' + content + '</pre>');
                printWindow.document.close();
                printWindow.print();
            }

       </script>

{% endblock content %}




